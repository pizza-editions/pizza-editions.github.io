name: IndexNow Submit

on:
  workflow_run:
    workflows: ["Deploy GitHub Pages"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests lxml

      - name: Submit URLs from Sitemap to IndexNow
        run: |
          python - <<EOF
          import requests, json
          from lxml import etree

          key = "5607a2f1e8694f6b888e9d1dbc53fc15"
          sitemap_url = "https://pizza-editions.github.io/sitemap.xml"

          r = requests.get(sitemap_url)
          r.raise_for_status()

          tree = etree.fromstring(r.content)
          ns = {"ns": "http://www.sitemaps.org/schemas/sitemap/0.9"}
          urls = [loc.text for loc in tree.xpath("//ns:loc", namespaces=ns)]

          payload = {
              "host": "pizza-editions.github.io",
              "key": key,
              "keyLocation": f"https://pizza-editions.github.io/{key}.txt",
              "urlList": urls
          }

          resp = requests.post(
              "https://api.indexnow.org/indexnow",
              headers={"Content-Type": "application/json"},
              data=json.dumps(payload)
          )

          print("Total URLs:", len(urls))
          print("Status:", resp.status_code)
          print(resp.text)
          EOF
